<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modificar o Anular Cita</title>
  <link rel="stylesheet" href="style-modificar.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <main class="container">
    <h1>‚úèÔ∏è Modificar o Anular Cita</h1>
    <input type="text" id="idBusqueda" placeholder="Ingresa tu ID de reserva">
    <button id="buscar">Buscar</button>

    <form id="form-modificar" class="oculto">
      <input type="hidden" id="idReserva" name="idReserva">

      <label for="nombre">Nombre:</label>
      <input type="text" id="nombre" name="nombre" required>

      <label for="nacimiento">Fecha de Nacimiento:</label>
      <input type="date" id="nacimiento" name="nacimiento" required>

      <label for="telefono">Tel√©fono:</label>
      <input type="tel" id="telefono" name="telefono" required>

      <label for="correo">Correo:</label>
      <input type="email" id="correo" name="correo" required>

      <label for="signo">Signo Zodiacal:</label>
      <select id="signo" name="signo" required>
        <option value="">-- Selecciona --</option>
        <option value="Aries">Aries</option>
        <option value="Tauro">Tauro</option>
        <option value="G√©minis">G√©minis</option>
        <option value="C√°ncer">C√°ncer</option>
        <option value="Leo">Leo</option>
        <option value="Virgo">Virgo</option>
        <option value="Libra">Libra</option>
        <option value="Escorpio">Escorpio</option>
        <option value="Sagitario">Sagitario</option>
        <option value="Capricornio">Capricornio</option>
        <option value="Acuario">Acuario</option>
        <option value="Piscis">Piscis</option>
      </select>

      <label for="fecha">Nueva Fecha:</label>
      <input type="date" id="fecha" name="fecha" required>

      <label for="hora">Nueva Hora:</label>
      <input type="time" id="hora" name="hora" required>

      <div id="seleccion-horario" class="oculto">
        <p><strong>Selecciona un nuevo horario:</strong></p>
        <div class="horarios" id="horarios-nuevos"></div>
      </div>
      



      <button type="submit" class="confirmar">Guardar Cambios</button>
      <button type="button" id="anular" class="cancelar">Anular Cita</button>
    </form>
  </main>

  <!-- Modal de mensaje -->
  <div id="modal-info" class="modal oculto">
    <div class="modal-content">
      <span class="cerrar" onclick="document.getElementById('modal-info').classList.add('oculto')">&times;</span>
      <h3>‚õî Atenci√≥n</h3>
      <p>Esta cita ya fue <strong>confirmada</strong> y no puede modificarse desde aqu√≠.</p>
      <p>Para anular o reprogramar, por favor comun√≠cate v√≠a <a href="https://wa.me/51999999999" target="_blank">WhatsApp</a>.</p>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("form-modificar");
      const modal = document.getElementById("modal-info");
      const urlParams = new URLSearchParams(window.location.search);
const idPasado = urlParams.get("id");

if (idPasado) {
  document.getElementById("idBusqueda").value = idPasado;
  Swal.fire("üîÑ Cargando cita", `Buscando datos para ID: ${idPasado}`, "info");

  document.getElementById("buscar").click();
}

     
      document.getElementById("buscar").addEventListener("click", async () => {
  const id = document.getElementById("idBusqueda").value.trim();

  if (!id || id.length < 8 || !id.toUpperCase().startsWith("RA-")) {
    return Swal.fire("‚ö†Ô∏è Atenci√≥n", "Debes ingresar un ID de reserva v√°lido que empiece con RA-", "warning");
  }

  try {
    const res = await fetch(`/api/reserva?id=${encodeURIComponent(id)}`);
    const data = await res.json();

    console.log("üîé Respuesta de API:", data);

    if (!data || typeof data !== "object" || !("id" in data)) {
      return Swal.fire("‚ùå", "Reserva no encontrada", "error");
    }

    if (!data.estado || data.id.toUpperCase() !== id.toUpperCase()) {
      return Swal.fire("‚ùå", "Reserva inv√°lida", "error");
    }

    if (data.estado.trim().toLowerCase() === "confirmada") {
      return document.getElementById("modal-info").classList.remove("oculto");
    }

    // ‚úÖ Mostrar formulario con datos cargados
    const form = document.getElementById("form-modificar");
    form.classList.remove("oculto");

    document.getElementById("idReserva").value = data.id;
    document.getElementById("nombre").value = data.nombre;

    // ‚úÖ Formatear fecha de nacimiento a YYYY-MM-DD
    const nacimiento = new Date(data.nacimiento);
    const nacimientoISO = nacimiento.toISOString().split("T")[0];
    document.getElementById("nacimiento").value = nacimientoISO;

    document.getElementById("telefono").value = data.telefono;
    document.getElementById("correo").value = data.correo;
    document.getElementById("signo").value = data.signo;
    document.getElementById("fecha").value = data.fecha;
    document.getElementById("hora").value = data.hora;

  } catch (err) {
    console.error("‚ùå Error de API:", err);
    Swal.fire("‚ùå Error", "Ocurri√≥ un problema al consultar tu cita", "error");
  }
});


     

      // ‚úÖ Submit del formulario
      form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const formData = {
    id: form.idReserva.value,
    nombre: form.nombre.value,
    nacimiento: form.nacimiento.value,
    telefono: form.telefono.value,
    correo: form.correo.value,
    signo: form.signo.value,
    fecha: form.fecha.value,
    hora: form.hora.value,
  };

  // üßæ Modal previo de confirmaci√≥n
  const confirmar = await Swal.fire({
    title: "¬øConfirmar cambios?",
    html: `
      <p><strong>Fecha nueva:</strong> ${formData.fecha}</p>
      <p><strong>Hora nueva:</strong> ${formData.hora}</p>
      <p>¬øDeseas aplicar estos cambios?</p>
    `,
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "S√≠, guardar",
    cancelButtonText: "Cancelar"
  });

  if (!confirmar.isConfirmed) return;

  try {
    const res = await fetch("/api/admin/reserva", {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(formData),
    });

    if (!res.ok) throw new Error(await res.text());

    await Swal.fire("‚úÖ Modificaci√≥n exitosa", "Tu cita fue actualizada", "success");

    // ‚úÖ Limpiar y redirigir
    form.reset();
    form.classList.add("oculto");
    setTimeout(() => {
      window.location.href = "index.html"; // o la ruta que prefieras
    }, 1000);

  } catch (err) {
    console.error(err);
    Swal.fire("‚ùå Error", err.message, "error");
  }
});

    
    
    
    
    
      // ‚úÖ Bot√≥n de anular
      document.getElementById("anular").addEventListener("click", async () => {
        const id = document.getElementById("idReserva").value;
  
        const confirmar = await Swal.fire({
          title: "¬øEst√°s seguro?",
          text: "Esto eliminar√° tu cita por completo",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "S√≠, anular",
        });
  
        if (!confirmar.isConfirmed) return;
  
        try {
          const res = await fetch("/api/admin/reserva", {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id }),
          });
  
          if (!res.ok) throw new Error(await res.text());
  
          Swal.fire("üóëÔ∏è Anulada", "Tu cita ha sido anulada correctamente", "success");
          form.classList.add("oculto");
        } catch (err) {
          console.error(err);
          Swal.fire("‚ùå Error", "No se pudo anular la cita", "error");
        }
      });
      document.getElementById("fecha").addEventListener("change", async () => {
  const fechaSeleccionada = document.getElementById("fecha").value;
  const horariosDiv = document.getElementById("horarios-nuevos");
  const contenedor = document.getElementById("seleccion-horario");

  if (!fechaSeleccionada) return;
  horariosDiv.innerHTML = "";
  contenedor.classList.remove("oculto");

  const horariosDisponibles = [
    "10:00", "10:45", "11:30", "12:15", "13:00",
    "17:00", "17:45", "18:30", "19:15", "20:00", "20:45", "21:30"
  ];

  let ocupadas = [];

  try {
    const res = await fetch("/api/admin/reserva");
    const data = await res.json();

    ocupadas = data
      .filter(r => {
        const fechaBD = new Date(r.fecha).toISOString().split("T")[0];
        return (
          fechaBD === fechaSeleccionada &&
          r.estado.trim().toLowerCase() === "confirmada"
        );
      })
      .map(r => r.hora?.substring(0, 5));
  } catch (error) {
    console.error("‚ùå Error al cargar reservas:", error);
  }

  horariosDisponibles.forEach(hora => {
    const btn = document.createElement("button");
    btn.classList.add("horario-btn");
   
    btn.setAttribute("type", "button"); // üëà Este es el truco clave
    btn.textContent = hora;

    if (ocupadas.includes(hora)) {
      btn.classList.add("disabled");
      btn.disabled = true;
      btn.textContent += " ‚õî";
    } else {
      btn.onclick = () => {
        document.getElementById("hora").value = hora;
        contenedor.classList.add("oculto"); // ocultar los botones despu√©s de elegir
      };
    }

    horariosDiv.appendChild(btn);
  });
});





    });
  </script>
  
</body>
</html>
