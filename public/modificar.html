<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modificar o Anular Cita</title>
  <link rel="stylesheet" href="style-modificar.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <main class="container">
    <h1>‚úèÔ∏è Modificar o Anular Cita</h1>
    <input type="text" id="idBusqueda" placeholder="Ingresa tu ID de reserva">
    <button id="buscar">Buscar</button>

    <form id="form-modificar" class="oculto">
      <input type="hidden" id="idReserva" name="idReserva">

      <label for="nombre">Nombre:</label>
      <input type="text" id="nombre" name="nombre" required>

      <label for="nacimiento">Fecha de Nacimiento:</label>
      <input type="date" id="nacimiento" name="nacimiento" required>

      <label for="telefono">Tel√©fono:</label>
      <input type="tel" id="telefono" name="telefono" required>

      <label for="correo">Correo:</label>
      <input type="email" id="correo" name="correo" required>

      <label for="signo">Signo Zodiacal:</label>
      <select id="signo" name="signo" required>
        <option value="">-- Selecciona --</option>
        <option value="Aries">Aries</option>
        <option value="Tauro">Tauro</option>
        <option value="G√©minis">G√©minis</option>
        <option value="C√°ncer">C√°ncer</option>
        <option value="Leo">Leo</option>
        <option value="Virgo">Virgo</option>
        <option value="Libra">Libra</option>
        <option value="Escorpio">Escorpio</option>
        <option value="Sagitario">Sagitario</option>
        <option value="Capricornio">Capricornio</option>
        <option value="Acuario">Acuario</option>
        <option value="Piscis">Piscis</option>
      </select>

      <label for="fecha">Nueva Fecha:</label>
      <input type="date" id="fecha" name="fecha" required>

      <label for="hora">Nueva Hora:</label>
      <input type="time" id="hora" name="hora" required>

      <button type="submit" class="confirmar">Guardar Cambios</button>
      <button type="button" id="anular" class="cancelar">Anular Cita</button>
    </form>
  </main>

  <!-- Modal de mensaje -->
  <div id="modal-info" class="modal oculto">
    <div class="modal-content">
      <span class="cerrar" onclick="document.getElementById('modal-info').classList.add('oculto')">&times;</span>
      <h3>‚õî Atenci√≥n</h3>
      <p>Esta cita ya fue <strong>confirmada</strong> y no puede modificarse desde aqu√≠.</p>
      <p>Para anular o reprogramar, por favor comun√≠cate v√≠a <a href="https://wa.me/51999999999" target="_blank">WhatsApp</a>.</p>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("form-modificar");
      const modal = document.getElementById("modal-info");
  
      document.getElementById("buscar").addEventListener("click", async () => {
        const id = document.getElementById("idBusqueda").value.trim();
  
        if (!id || id.length < 8 || !id.toUpperCase().startsWith("RA-")) {
          return Swal.fire("‚ö†Ô∏è Atenci√≥n", "Debes ingresar un ID de reserva v√°lido que empiece con RA-", "warning");
        }
  
        try {
          const res = await fetch(`/api/reserva?id=${encodeURIComponent(id)}`);
          const data = await res.json();
  
          console.log("üîé Respuesta de API:", data);
  
          if (!data || !data.id || !data.estado || data.id.toUpperCase() !== id.toUpperCase()) {
            return Swal.fire("‚ùå", "Reserva no encontrada o inv√°lida", "error");
          }
  
          if (data.estado.trim().toLowerCase() === "confirmada") {
            return modal.classList.remove("oculto");
          }
  
          // ‚úÖ Mostrar formulario con datos cargados
          form.classList.remove("oculto");
          document.getElementById("idReserva").value = data.id;
          document.getElementById("nombre").value = data.nombre;
          document.getElementById("nacimiento").value = data.nacimiento;
          document.getElementById("telefono").value = data.telefono;
          document.getElementById("correo").value = data.correo;
          document.getElementById("signo").value = data.signo;
          document.getElementById("fecha").value = data.fecha;
          document.getElementById("hora").value = data.hora;
  
        } catch (err) {
          console.error("‚ùå Error de API:", err);
          Swal.fire("‚ùå Error", "Ocurri√≥ un problema al consultar tu cita", "error");
        }
      });
  
      // ‚úÖ Submit del formulario
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
  
        const formData = {
          id: form.idReserva.value,
          nombre: form.nombre.value,
          nacimiento: form.nacimiento.value,
          telefono: form.telefono.value,
          correo: form.correo.value,
          signo: form.signo.value,
          fecha: form.fecha.value,
          hora: form.hora.value,
        };
  
        try {
          const res = await fetch("/api/admin/reserva", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData),
          });
  
          if (!res.ok) throw new Error(await res.text());
  
          Swal.fire("‚úÖ Cambios guardados", "Tu cita fue actualizada correctamente", "success");
        } catch (err) {
          console.error(err);
          Swal.fire("‚ùå Error", err.message, "error");
        }
      });
  
      // ‚úÖ Bot√≥n de anular
      document.getElementById("anular").addEventListener("click", async () => {
        const id = document.getElementById("idReserva").value;
  
        const confirmar = await Swal.fire({
          title: "¬øEst√°s seguro?",
          text: "Esto eliminar√° tu cita por completo",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "S√≠, anular",
        });
  
        if (!confirmar.isConfirmed) return;
  
        try {
          const res = await fetch("/api/admin/reserva", {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id }),
          });
  
          if (!res.ok) throw new Error(await res.text());
  
          Swal.fire("üóëÔ∏è Anulada", "Tu cita ha sido anulada correctamente", "success");
          form.classList.add("oculto");
        } catch (err) {
          console.error(err);
          Swal.fire("‚ùå Error", "No se pudo anular la cita", "error");
        }
      });
    });
  </script>
  
</body>
</html>
