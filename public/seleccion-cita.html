<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Selecciona tu cita</title>
  <link rel="stylesheet" href="style-seleccioncita.css" />
</head>
<body>
  <div class="calendar-wrapper">
    <h2>Selecciona tu día</h2>
    <input type="date" id="fecha" min="" />
    <div id="mensaje"></div>
    <div class="horarios" id="horarios"></div>
  </div>

  <script>
    const zonaCliente = Intl.DateTimeFormat().resolvedOptions().timeZone;

    const fechaInput = document.getElementById("fecha");
    const horariosDiv = document.getElementById("horarios");
    const mensaje = document.getElementById("mensaje");

    const horariosDisponibles = [
      "10:00", "10:45", "11:30", "12:15", "13:00",
      "17:00", "17:45", "18:30", "19:15", "20:00", "20:45", "21:30"
    ];

    // Simulación de horarios ya reservados (esto luego se debe consultar desde la BD real)
    const reservasExistentes = [
      { fecha: "2025-04-25", hora: "10:00", estado: "confirmada" },
      { fecha: "2025-04-25", hora: "17:45", estado: "pendiente" }
    ];

    const hoy = new Date().toISOString().split("T")[0];
    fechaInput.setAttribute("min", hoy);

    // Función para convertir hora de España a hora local del usuario
    function convertirHoraEspañaALocal(horaStr, fechaStr) {
      const [h, m] = horaStr.split(":");
      const fechaBase = `${fechaStr}T${h}:${m}:00`;

      const opcionesEspaña = {
        timeZone: "Europe/Madrid",
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      };

      const opcionesLocal = {
        timeZone: zonaCliente,
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      };

      const fechaEspaña = new Date(fechaBase);
      const formatterLocal = new Intl.DateTimeFormat("default", opcionesLocal);
      const formatterMadrid = new Intl.DateTimeFormat("default", opcionesEspaña);

      const horaLocal = formatterLocal.format(fechaEspaña);
      return horaLocal;
    }

    fechaInput.addEventListener("change", () => {
      const fechaSeleccionada = new Date(fechaInput.value);
      const diaSemana = fechaSeleccionada.getDay();
      const fechaStr = fechaInput.value;

      horariosDiv.innerHTML = "";
      mensaje.innerHTML = "";

      if (diaSemana === 0) {
        mensaje.innerHTML = "<p><strong>Los domingos no hay atención.</strong></p>";
        return;
      }

      mensaje.innerHTML = `<p><strong>Horarios disponibles para el ${fechaStr}</strong></p>`;

      horariosDisponibles.forEach(hora => {
        const estaReservado = reservasExistentes.some(r =>
          r.fecha === fechaStr && r.hora === hora && r.estado !== "cancelada"
        );

        const horaLocal = convertirHoraEspañaALocal(hora, fechaStr);

        const btn = document.createElement("button");
        btn.classList.add("horario-btn");
        btn.textContent = `${horaLocal} (${hora} 🇪🇸)`;

        if (estaReservado) {
          btn.disabled = true;
          btn.classList.add("disabled");
          btn.title = "Ya reservado";
        } else {
          btn.onclick = () => {
            const url = new URL("reserva.html", window.location.origin);
            url.searchParams.set("fecha", fechaStr);
            url.searchParams.set("hora", hora); // hora original España
            window.location.href = url;
          };
        }

        horariosDiv.appendChild(btn);
      });
    });
  </script>
</body>
</html>
